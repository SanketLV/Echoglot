# Architecture

> Auto-generated by /map on 2026-02-22

## Overview

Echoglot is a real-time voice & chat translation platform. Users speak/type in their native language and the message is translated into the recipient's preferred language — eventually in the sender's own voice.

The system is a **pnpm monorepo** managed by **Turborepo** with three workspace layers: apps, services, and packages.

```
┌─────────────────────────────────────────────────────────────┐
│                   CLIENT (Next.js 15)                       │
│  React 19 • Tailwind CSS • shadcn/ui • Zustand • TanStack  │
│  ┌──────────────┐  ┌──────────────┐  ┌────────────────┐    │
│  │  Auth (auth)  │  │  Chat (app)  │  │  Settings/etc  │    │
│  └──────────────┘  └──────┬───────┘  └────────────────┘    │
│         │                 │                                  │
│    Supabase Auth     REST + WebSocket                       │
│     (direct)         (via API client)                       │
├─────────────────────────────┼───────────────────────────────┤
│                   API GATEWAY (Fastify 5)                   │
│  ┌────────┐  ┌────────────┐  ┌────────────────────────┐    │
│  │ Plugins│  │  REST /v1  │  │  WebSocket /ws/chat    │    │
│  │ (auth, │  │  (users,   │  │  (real-time messages)  │    │
│  │ error, │  │  contacts, │  │                        │    │
│  │ ws)    │  │  convos,   │  │                        │    │
│  └────────┘  │  health)   │  └──────────┬─────────────┘    │
│              └──────┬─────┘             │                   │
│                     │            ┌──────┴──────┐            │
│              ┌──────┴──────┐     │   PubSub    │            │
│              │  DB Layer   │     │  (Redis)    │            │
│              └──────┬──────┘     └──────┬──────┘            │
│                     │                   │                   │
│              ┌──────┴──────────────────┬┘                   │
│              │  Translation Service   │                    │
│              │  (DeepL → Google →     │                    │
│              │   MyMemory fallback)   │                    │
│              │  + Redis cache         │                    │
│              └────────────────────────┘                    │
├─────────────────────────────────────────────────────────────┤
│                   DATA LAYER                                │
│  ┌─────────────────────┐  ┌─────────────────────┐          │
│  │  PostgreSQL          │  │  Redis (Upstash)    │          │
│  │  (Supabase)          │  │  • Translation cache│          │
│  │  • users             │  │  • PubSub channels  │          │
│  │  • user_preferences  │  │                     │          │
│  │  • contacts          │  └─────────────────────┘          │
│  │  • conversations     │                                   │
│  │  • conversation_members                                  │
│  │  • messages          │                                   │
│  │  • message_translations                                  │
│  │  + RLS policies      │                                   │
│  └─────────────────────┘                                    │
└─────────────────────────────────────────────────────────────┘
```

## Components

### Frontend — `apps/web/` (@echoglot/web)

- **Purpose:** Next.js 15 App Router SPA for chat UI, auth, contacts, settings
- **Location:** `apps/web/src/`
- **Dependencies:** `@echoglot/shared-types`, `@echoglot/ui`, Supabase SSR, TanStack Query, Zustand, Zod

**Key subdirectories:**

| Path | Purpose |
|------|---------|
| `app/(auth)/` | Login, signup, onboarding, password reset, OAuth callback |
| `app/(app)/` | Dashboard, chat, contacts, settings (protected routes) |
| `components/auth/` | Auth UI components |
| `components/chat/` | Chat UI (message list, input, conversation list) |
| `components/layout/` | App shell layout |
| `components/providers/` | React context providers (query, theme, etc.) |
| `components/shared/` | Reusable shared components |
| `hooks/` | 7 custom hooks (auth, chat-actions, chat-ws, contacts, conversations, messages, user) |
| `stores/` | Zustand stores (chat-store, user-store) |
| `lib/` | API client, WebSocket client, Supabase client (browser/server/middleware), Zod validations |

**Middleware:** `middleware.ts` refreshes Supabase session on every request.

---

### API Gateway — `services/api-gateway/` (@echoglot/api-gateway)

- **Purpose:** Fastify 5 REST + WebSocket API for business logic
- **Location:** `services/api-gateway/src/`
- **Dependencies:** Fastify 5, Supabase JS, DeepL, ioredis, Zod

**Key subdirectories:**

| Path | Purpose |
|------|---------|
| `config/` | Environment validation (Zod), Redis client, Supabase admin client |
| `plugins/` | Fastify plugins — auth (JWT verification), error-handler, websocket |
| `routes/` | REST endpoints under `/v1` — auth, users, contacts, conversations, health; WebSocket at `/ws/chat` |
| `db/` | Database query layer — contacts, conversations, messages, preferences, users |
| `schemas/` | Zod request/response schemas — auth, contact, conversation, user |
| `services/` | Business logic — PubSub (Redis), Translation service |
| `types/` | Server-side type definitions |

**Route structure:**
- `GET/POST /v1/auth/*` — Token exchange, session
- `GET/PUT /v1/users/*` — Profile, preferences
- `GET/POST/DELETE /v1/contacts/*` — Contact management
- `GET/POST /v1/conversations/*` — Conversations + messages
- `GET /v1/health` — Health check
- `WS /ws/chat` — Real-time chat WebSocket

---

### Translation Service — `services/api-gateway/src/services/translation/`

- **Purpose:** Multi-engine translation with smart routing and caching
- **Engines:** DeepL (European/CJK languages), Google Translate (broad), MyMemory (free fallback)
- **Strategy:** Engine priority by language pair, automatic fallback, Redis cache
- **Pattern:** Singleton router, engine interface pattern

---

### PubSub — `services/api-gateway/src/services/pubsub.ts`

- **Purpose:** Real-time message delivery via Redis pub/sub
- **Pattern:** Per-WS-connection PubSub instances (ioredis subscriber limitation)
- **Channels:** `user:{userId}` for per-user message delivery

---

### Shared Types — `packages/shared-types/` (@echoglot/shared-types)

- **Purpose:** TypeScript type definitions shared between frontend and backend
- **Exports:** API types, auth types, contact, conversation, message, user types, database types, enums

---

### UI Library — `packages/ui/` (@echoglot/ui)

- **Purpose:** Shared shadcn/ui component library
- **Components (17):** Avatar, Badge, Button, Card, Dialog, DropdownMenu, Input, Label, Select, Separator, Skeleton, Switch, Tabs, Toast, Toaster, useToast

---

### Config — `packages/config/` (@echoglot/config)

- **Purpose:** Shared configuration packages
- **Subpackages:** ESLint config, TypeScript config, Tailwind config (design tokens)

---

### Database — `supabase/`

- **Purpose:** PostgreSQL via Supabase with 11 migrations
- **Tables:** `users`, `user_preferences`, `contacts`, `conversations`, `conversation_members`, `messages`, `message_translations`
- **Security:** Row Level Security (RLS) policies for all tables
- **Triggers:** Auth trigger (auto-create user profile), `updated_at` trigger

## Data Flow

### Authentication
1. User signs in via Supabase Auth (frontend direct)
2. Supabase returns JWT
3. Frontend sends JWT in Authorization header to API Gateway
4. Auth plugin verifies JWT via Supabase admin client
5. User ID extracted and attached to request

### Chat (Send Message)
1. User types message in chat UI
2. Frontend sends message via WebSocket to `/ws/chat`
3. API Gateway validates auth, stores message in DB
4. Translation service translates to recipient's `preferred_lang`
5. Translation cached in Redis + stored in `message_translations` table
6. PubSub publishes translated message to recipient's channel
7. Recipient's WebSocket connection receives and delivers message

### Chat (Receive Message)
1. WebSocket connection subscribes to `user:{userId}` PubSub channel
2. When a message is published to the channel, WebSocket pushes it to client
3. Frontend updates Zustand chat store + UI

## Integration Points

| Service | Type | Purpose |
|---------|------|---------|
| Supabase Auth | SDK | User authentication + OAuth |
| Supabase DB | SDK | PostgreSQL database (RLS) |
| DeepL | REST API | Premium translation (European/CJK) |
| Google Translate | REST API | Broad language translation |
| MyMemory | REST API | Free translation fallback |
| Redis (Upstash) | TCP | Translation cache + PubSub |
| Docker | Container | Redis local dev |

## Technical Debt

- [ ] No automated tests (unit, integration, or E2E) anywhere in the codebase
- [ ] No CI/CD pipeline configured (`.github/` has directory but needs review)
- [ ] Voice features not yet implemented (users table has `voice_profile_id` column but unused)
- [ ] No rate limiting on API endpoints
- [ ] No input sanitization beyond Zod validation
- [ ] PubSub creates new Redis connections per WebSocket — may not scale
- [ ] No structured error codes (error-handler plugin exists but generic)
- [ ] No logging strategy beyond Pino defaults
- [ ] No monitoring/alerting infrastructure
- [ ] Docker Compose only runs Redis — no full local dev stack
- [ ] No database seeding beyond empty `seed.sql`

## Conventions

**Naming:** camelCase for TypeScript, snake_case for database columns
**Structure:** Feature-based directory organization (routes/contacts/, routes/conversations/, etc.)
**Validation:** Zod schemas for both env vars and API request/response
**State management:** Zustand for client state, TanStack Query for server state
**Styling:** Tailwind CSS with shadcn/ui components
**Monorepo:** Turborepo for build orchestration, pnpm workspaces for dependency management
